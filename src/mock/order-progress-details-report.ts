import type {
  OrderProgressCategory,
  OrderProgressDetailsListParams,
  OrderProgressDetailsListResponse,
  OrderProgressDetailsRecord,
} from '../types/order-progress-details-report';

const delay = (ms: number) => new Promise((resolve) => setTimeout(resolve, ms));

const buildCategories = (
  overrides: Partial<Record<OrderProgressCategory['key'], Partial<OrderProgressCategory>>>,
  totalQty: number,
): OrderProgressCategory[] => {
  const base: Record<OrderProgressCategory['key'], OrderProgressCategory> = {
    cutting: {
      key: 'cutting',
      name: '裁床',
      completedQty: totalQty,
      totalQty,
      onSchedule: true,
    },
    sewing: {
      key: 'sewing',
      name: '车缝',
      completedQty: Math.round(totalQty * 0.68),
      totalQty,
      onSchedule: true,
    },
    finishing: {
      key: 'finishing',
      name: '后整',
      completedQty: Math.round(totalQty * 0.42),
      totalQty,
      onSchedule: false,
      bottleneck: true,
    },
    quality: {
      key: 'quality',
      name: '质检',
      completedQty: Math.round(totalQty * 0.38),
      totalQty,
      onSchedule: false,
    },
    packaging: {
      key: 'packaging',
      name: '包装',
      completedQty: Math.round(totalQty * 0.34),
      totalQty,
      onSchedule: false,
    },
    storage: {
      key: 'storage',
      name: '入库',
      completedQty: Math.round(totalQty * 0.31),
      totalQty,
      onSchedule: false,
    },
  };

  return Object.entries(base).map(([key, value]) => ({
    ...value,
    ...(overrides[key as OrderProgressCategory['key']] ?? {}),
  }));
};

const dataset: OrderProgressDetailsRecord[] = [
  {
    id: 'order-001',
    orderNumber: 'ET0032-202405',
    customer: '杭州锐动体育',
    orderDate: '2024-05-15',
    styleNumber: 'ET0032',
    styleName: '速干跑步T恤',
    orderQuantity: 3200,
    cuttingDate: '2024-05-18',
    actualCutQuantity: 3180,
    dispatchDate: '2024-06-28',
    deliveryDate: '2024-07-02',
    totalProcessPrice: 185600,
    orderStatus: 'inProgress',
    progressPercent: 62,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 1980 },
        finishing: { completedQty: 1240, onSchedule: false, bottleneck: true },
        quality: { completedQty: 1180, onSchedule: false },
        packaging: { completedQty: 960 },
        storage: { completedQty: 820 },
      },
      3200,
    ),
  },
  {
    id: 'order-002',
    orderNumber: 'ET1120-202404',
    customer: '宁波杉杉服饰',
    orderDate: '2024-04-22',
    styleNumber: 'ET1120',
    styleName: '商务弹力衬衫',
    orderQuantity: 1800,
    cuttingDate: '2024-04-25',
    actualCutQuantity: 1800,
    dispatchDate: '2024-05-28',
    deliveryDate: '2024-06-01',
    totalProcessPrice: 146520,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 1800 },
        finishing: { completedQty: 1800, onSchedule: true, bottleneck: false },
        quality: { completedQty: 1800, onSchedule: true },
        packaging: { completedQty: 1800, onSchedule: true },
        storage: { completedQty: 1800, onSchedule: true },
      },
      1800,
    ),
  },
  {
    id: 'order-003',
    orderNumber: 'ET2088-202405',
    customer: '广州乐动体育',
    orderDate: '2024-05-06',
    styleNumber: 'ET2088',
    styleName: '拼色篮球背心',
    orderQuantity: 2400,
    cuttingDate: '2024-05-09',
    actualCutQuantity: 2400,
    dispatchDate: '2024-06-20',
    deliveryDate: '2024-06-25',
    totalProcessPrice: 132480,
    orderStatus: 'inProgress',
    progressPercent: 74,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2050 },
        finishing: { completedQty: 1680, onSchedule: true, bottleneck: false },
        quality: { completedQty: 1620, onSchedule: true },
        packaging: { completedQty: 1540, onSchedule: true },
        storage: { completedQty: 1420 },
      },
      2400,
    ),
  },
  {
    id: 'order-004',
    orderNumber: 'ET3051-202404',
    customer: '无锡尚雅童装',
    orderDate: '2024-04-10',
    styleNumber: 'ET3051',
    styleName: '儿童绣花卫衣',
    orderQuantity: 1500,
    cuttingDate: '2024-04-14',
    actualCutQuantity: 1490,
    dispatchDate: '2024-05-30',
    deliveryDate: '2024-06-05',
    totalProcessPrice: 93600,
    orderStatus: 'delayed',
    progressPercent: 48,
    progressTrend: 'down',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 830, onSchedule: false },
        finishing: { completedQty: 520, onSchedule: false, bottleneck: true },
        quality: { completedQty: 460, onSchedule: false },
        packaging: { completedQty: 380 },
        storage: { completedQty: 320 },
      },
      1500,
    ),
  },
  {
    id: 'order-005',
    orderNumber: 'ET5201-202405',
    customer: '苏州陌上花开',
    orderDate: '2024-05-12',
    styleNumber: 'ET5201',
    styleName: '气质针织连衣裙',
    orderQuantity: 900,
    cuttingDate: '2024-05-15',
    actualCutQuantity: 900,
    dispatchDate: '2024-06-30',
    deliveryDate: '2024-07-05',
    totalProcessPrice: 104400,
    orderStatus: 'inProgress',
    progressPercent: 55,
    progressTrend: 'flat',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 510 },
        finishing: { completedQty: 320, bottleneck: true },
        quality: { completedQty: 300 },
        packaging: { completedQty: 260 },
        storage: { completedQty: 210 },
      },
      900,
    ),
  },
  {
    id: 'order-006',
    orderNumber: 'ET6015-202403',
    customer: '上海明禾制服',
    orderDate: '2024-03-26',
    styleNumber: 'ET6015',
    styleName: '三防机修工装',
    orderQuantity: 2600,
    cuttingDate: '2024-03-30',
    actualCutQuantity: 2590,
    dispatchDate: '2024-05-12',
    deliveryDate: '2024-05-16',
    totalProcessPrice: 208000,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2600 },
        finishing: { completedQty: 2600, onSchedule: true, bottleneck: false },
        quality: { completedQty: 2600, onSchedule: true },
        packaging: { completedQty: 2600, onSchedule: true },
        storage: { completedQty: 2600, onSchedule: true },
      },
      2600,
    ),
  },
  {
    id: 'order-007',
    orderNumber: 'ET7090-202404',
    customer: '杭州果壳童装',
    orderDate: '2024-04-18',
    styleNumber: 'ET7090',
    styleName: '亲子户外功能服',
    orderQuantity: 1200,
    cuttingDate: '2024-04-22',
    actualCutQuantity: 1200,
    dispatchDate: '2024-06-10',
    deliveryDate: '2024-06-16',
    totalProcessPrice: 118800,
    orderStatus: 'inProgress',
    progressPercent: 67,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 870 },
        finishing: { completedQty: 640 },
        quality: { completedQty: 610 },
        packaging: { completedQty: 520 },
        storage: { completedQty: 460 },
      },
      1200,
    ),
  },
  {
    id: 'order-008',
    orderNumber: 'ET8103-202405',
    customer: '深圳向阳运动',
    orderDate: '2024-05-10',
    styleNumber: 'ET8103',
    styleName: '无缝瑜伽套装',
    orderQuantity: 2000,
    cuttingDate: '2024-05-14',
    actualCutQuantity: 1990,
    dispatchDate: '2024-07-01',
    deliveryDate: '2024-07-06',
    totalProcessPrice: 224600,
    orderStatus: 'new',
    progressPercent: 28,
    progressTrend: 'flat',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 420, onSchedule: false },
        finishing: { completedQty: 280, bottleneck: true },
        quality: { completedQty: 240 },
        packaging: { completedQty: 200 },
        storage: { completedQty: 160 },
      },
      2000,
    ),
  },
  {
    id: 'order-009',
    orderNumber: 'ET9056-202403',
    customer: '成都云杉户外',
    orderDate: '2024-03-18',
    styleNumber: 'ET9056',
    styleName: '轻量冲锋衣',
    orderQuantity: 2800,
    cuttingDate: '2024-03-22',
    actualCutQuantity: 2780,
    dispatchDate: '2024-05-05',
    deliveryDate: '2024-05-12',
    totalProcessPrice: 276360,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2800 },
        finishing: { completedQty: 2800, onSchedule: true, bottleneck: false },
        quality: { completedQty: 2800, onSchedule: true },
        packaging: { completedQty: 2800, onSchedule: true },
        storage: { completedQty: 2800, onSchedule: true },
      },
      2800,
    ),
  },
  {
    id: 'order-010',
    orderNumber: 'ET1021-202405',
    customer: '大连和颐家纺',
    orderDate: '2024-05-08',
    styleNumber: 'ET1021',
    styleName: '凉感家居套装',
    orderQuantity: 1600,
    cuttingDate: '2024-05-12',
    actualCutQuantity: 1600,
    dispatchDate: '2024-06-24',
    deliveryDate: '2024-06-30',
    totalProcessPrice: 102400,
    orderStatus: 'inProgress',
    progressPercent: 58,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 960 },
        finishing: { completedQty: 620 },
        quality: { completedQty: 590 },
        packaging: { completedQty: 520 },
        storage: { completedQty: 460 },
      },
      1600,
    ),
  },
  {
    id: 'order-011',
    orderNumber: 'ET1180-202402',
    customer: '长沙新势力',
    orderDate: '2024-02-26',
    styleNumber: 'ET1180',
    styleName: '春夏POLO衫',
    orderQuantity: 3000,
    cuttingDate: '2024-02-29',
    actualCutQuantity: 3000,
    dispatchDate: '2024-04-10',
    deliveryDate: '2024-04-16',
    totalProcessPrice: 189000,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 3000 },
        finishing: { completedQty: 3000, onSchedule: true, bottleneck: false },
        quality: { completedQty: 3000, onSchedule: true },
        packaging: { completedQty: 3000, onSchedule: true },
        storage: { completedQty: 3000, onSchedule: true },
      },
      3000,
    ),
  },
  {
    id: 'order-012',
    orderNumber: 'ET1288-202405',
    customer: '佛山凯途运动',
    orderDate: '2024-05-20',
    styleNumber: 'ET1288',
    styleName: '四向弹篮球短裤',
    orderQuantity: 2100,
    cuttingDate: '2024-05-22',
    actualCutQuantity: 2100,
    dispatchDate: '2024-06-30',
    deliveryDate: '2024-07-06',
    totalProcessPrice: 134190,
    orderStatus: 'new',
    progressPercent: 24,
    progressTrend: 'flat',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 360, onSchedule: false },
        finishing: { completedQty: 220, bottleneck: true },
        quality: { completedQty: 200 },
        packaging: { completedQty: 160 },
        storage: { completedQty: 140 },
      },
      2100,
    ),
  },
  {
    id: 'order-013',
    orderNumber: 'ET1389-202404',
    customer: '青岛润泰集团',
    orderDate: '2024-04-05',
    styleNumber: 'ET1389',
    styleName: '工装防静电夹克',
    orderQuantity: 2300,
    cuttingDate: '2024-04-09',
    actualCutQuantity: 2290,
    dispatchDate: '2024-06-12',
    deliveryDate: '2024-06-18',
    totalProcessPrice: 207070,
    orderStatus: 'inProgress',
    progressPercent: 69,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 1600 },
        finishing: { completedQty: 1220, onSchedule: true },
        quality: { completedQty: 1160 },
        packaging: { completedQty: 1010 },
        storage: { completedQty: 940 },
      },
      2300,
    ),
  },
  {
    id: 'order-014',
    orderNumber: 'ET1486-202403',
    customer: '厦门耐驰户外',
    orderDate: '2024-03-12',
    styleNumber: 'ET1486',
    styleName: '防水登山裤',
    orderQuantity: 2600,
    cuttingDate: '2024-03-15',
    actualCutQuantity: 2590,
    dispatchDate: '2024-05-08',
    deliveryDate: '2024-05-14',
    totalProcessPrice: 228800,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2600 },
        finishing: { completedQty: 2600, onSchedule: true },
        quality: { completedQty: 2600, onSchedule: true },
        packaging: { completedQty: 2600, onSchedule: true },
        storage: { completedQty: 2600, onSchedule: true },
      },
      2600,
    ),
  },
  {
    id: 'order-015',
    orderNumber: 'ET1580-202405',
    customer: '天津星火集团',
    orderDate: '2024-05-02',
    styleNumber: 'ET1580',
    styleName: '夏季工作服套装',
    orderQuantity: 3400,
    cuttingDate: '2024-05-06',
    actualCutQuantity: 3380,
    dispatchDate: '2024-06-28',
    deliveryDate: '2024-07-03',
    totalProcessPrice: 244800,
    orderStatus: 'inProgress',
    progressPercent: 61,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2200 },
        finishing: { completedQty: 1500, onSchedule: false, bottleneck: true },
        quality: { completedQty: 1440 },
        packaging: { completedQty: 1300 },
        storage: { completedQty: 1180 },
      },
      3400,
    ),
  },
  {
    id: 'order-016',
    orderNumber: 'ET1682-202404',
    customer: '北京途岳体育',
    orderDate: '2024-04-20',
    styleNumber: 'ET1682',
    styleName: '城市轻旅夹克',
    orderQuantity: 1900,
    cuttingDate: '2024-04-23',
    actualCutQuantity: 1890,
    dispatchDate: '2024-06-18',
    deliveryDate: '2024-06-24',
    totalProcessPrice: 176700,
    orderStatus: 'inProgress',
    progressPercent: 64,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 1280 },
        finishing: { completedQty: 980 },
        quality: { completedQty: 930 },
        packaging: { completedQty: 850 },
        storage: { completedQty: 780 },
      },
      1900,
    ),
  },
  {
    id: 'order-017',
    orderNumber: 'ET1780-202402',
    customer: '合肥三叶草',
    orderDate: '2024-02-16',
    styleNumber: 'ET1780',
    styleName: '亲肤家居服',
    orderQuantity: 2800,
    cuttingDate: '2024-02-20',
    actualCutQuantity: 2790,
    dispatchDate: '2024-04-02',
    deliveryDate: '2024-04-08',
    totalProcessPrice: 168000,
    orderStatus: 'completed',
    progressPercent: 100,
    progressTrend: 'up',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 2800 },
        finishing: { completedQty: 2800, onSchedule: true },
        quality: { completedQty: 2800, onSchedule: true },
        packaging: { completedQty: 2800, onSchedule: true },
        storage: { completedQty: 2800, onSchedule: true },
      },
      2800,
    ),
  },
  {
    id: 'order-018',
    orderNumber: 'ET1882-202405',
    customer: '常州逐日体育',
    orderDate: '2024-05-18',
    styleNumber: 'ET1882',
    styleName: '防晒骑行服',
    orderQuantity: 1400,
    cuttingDate: '2024-05-21',
    actualCutQuantity: 1400,
    dispatchDate: '2024-06-30',
    deliveryDate: '2024-07-04',
    totalProcessPrice: 112000,
    orderStatus: 'new',
    progressPercent: 22,
    progressTrend: 'down',
    categorySummary: buildCategories(
      {
        sewing: { completedQty: 260, onSchedule: false },
        finishing: { completedQty: 180, bottleneck: true },
        quality: { completedQty: 150 },
        packaging: { completedQty: 120 },
        storage: { completedQty: 100 },
      },
      1400,
    ),
  },
];

export const fetchOrderProgressDetailsList = async (
  params: OrderProgressDetailsListParams,
): Promise<OrderProgressDetailsListResponse> => {
  await delay(500);

  const { keyword, orderDateStart, orderDateEnd, page, pageSize } = params;

  let filtered = dataset.slice();

  if (keyword?.trim()) {
    const normalized = keyword.trim().toLowerCase();
    filtered = filtered.filter((item) =>
      [
        item.orderNumber,
        item.customer,
        item.styleNumber,
        item.styleName,
      ]
        .filter(Boolean)
        .some((value) => value.toLowerCase().includes(normalized)),
    );
  }

  if (orderDateStart) {
    filtered = filtered.filter((item) => item.orderDate >= orderDateStart);
  }

  if (orderDateEnd) {
    filtered = filtered.filter((item) => item.orderDate <= orderDateEnd);
  }

  const total = filtered.length;
  const startIndex = Math.max(0, (page - 1) * pageSize);
  const endIndex = startIndex + pageSize;

  return {
    list: filtered.slice(startIndex, endIndex),
    total,
  };
};

export const exportOrderProgressDetails = async (
  params: OrderProgressDetailsListParams,
): Promise<{ fileUrl: string }> => {
  await delay(800);
  const keywordSegment = params.keyword?.trim() ? `_${params.keyword.trim()}` : '';
  const timestamp = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
  return {
    fileUrl: `/downloads/order-progress-details${keywordSegment}_${timestamp}.xlsx`,
  };
};
